<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style type="text/css">
        .chat-session {
            border: 1px solid black;
            width: 350px;
            height: 350px;
            padding: 3px 3px 3px 3px;
        }

    </style>
    <script src="../Scripts/jquery-1.7.1.min.js" type="text/javascript"></script>
    <script src="../Scripts/jquery.signalR-0.5.3.min.js" type="text/javascript"></script>
    <script src="/signalr/hubs" type="text/javascript"></script>

    <script type="text/javascript">
        var status = true;

        $(function () {
            var myHub = $.connection.chatHub;

            $('#change-status').click(function () {
                status = !status;
                myHub.changeStatus(status);

                $(this).text(status ? 'Offline' : 'Online');
            });

            $('#chat-requests').on({
                click: function() {
                    var requestId = $(this).data('id');
                    $('#chat-sessions').append(
                        '<div id="chat' + requestId + '" class="chat-session" data-id="' + requestId + '">' +
                            '<div class="msgs"></div>' +
                            '<input type="text" class="chat-input"><button class="chat-btn">Send</button>' +
                        '</div>'
                    );

                    myHub.acceptChat(requestId);

                    $(this).remove();
                }
            }, '.chat-request');

            $('#chat-sessions').on({
                click: function () {
                    var parentDiv = $(this).parent();
                    var txt = parentDiv.find('.chat-input');
                    var chatId = parentDiv.data('id');

                    myHub.opSend(chatId, txt.val());

                    txt.val('');
                }
            }, '.chat-btn');

            myHub.newChat = function (id) {
                $('#chat-requests').append('<a href="#" class="chat-request" data-id="' + id + '">New chat (click to accept)</a><br />');
            };

            myHub.addMessage = function (id, value) {
                $('#chat' + id).find('.msgs').append(value);
            };

            $.connection.hub.start()
                .done(function () {
                    myHub.agentConnect('dominic');
                })
                .fail(function () { alert('unable to connect'); });
        });
    </script>
</head>
<body>
    Change your status tp <a href="#" id="change-status">Offline</a>

    <div id="chat-requests"></div>

    <div id="chat-sessions"></div>
</body>
</html>
